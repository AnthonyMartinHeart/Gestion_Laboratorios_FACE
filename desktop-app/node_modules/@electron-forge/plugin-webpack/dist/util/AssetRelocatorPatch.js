"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
class AssetRelocatorPatch {
    constructor(isProd, nodeIntegration) {
        this.isProd = isProd;
        this.nodeIntegration = nodeIntegration;
    }
    injectedProductionDirnameCode() {
        if (this.nodeIntegration) {
            // In production the assets are found one directory up from
            // __dirname
            return 'require("path").resolve(__dirname, "..")';
        }
        // If nodeIntegration is disabled, we replace __dirname
        // with an empty string so no error is thrown at runtime
        return '""';
    }
    apply(compiler) {
        compiler.hooks.compilation.tap('asset-relocator-forge-patch', (compilation) => {
            // We intercept the Vercel loader code injection and replace __dirname with
            // code that works with Electron Forge
            //
            // Here is where the injection occurs:
            // https://github.com/vercel/webpack-asset-relocator-loader/blob/4710a018fc8fb64ad51efb368759616fb273618f/src/asset-relocator.js#L331-L339
            compilation.mainTemplate.hooks.requireExtensions.intercept({
                register: (tapInfo) => {
                    if (tapInfo.name === 'asset-relocator-loader') {
                        const originalFn = tapInfo.fn;
                        tapInfo.fn = (source, chunk) => {
                            const originalInjectCode = originalFn(source, chunk);
                            // Since this is not a public API of the Vercel loader, it could
                            // change on patch versions and break things.
                            //
                            // If the injected code changes substantially, we throw an error
                            if (!originalInjectCode.includes('__webpack_require__.ab = __dirname + ')) {
                                throw new Error('The installed version of @vercel/webpack-asset-relocator-loader does not appear to be compatible with Forge');
                            }
                            if (this.isProd) {
                                return originalInjectCode.replace('__dirname', this.injectedProductionDirnameCode());
                            }
                            return originalInjectCode.replace('__dirname', 
                            // In development, the app is loaded via webpack-dev-server
                            // so __dirname is useless because it points to Electron
                            // internal code. Instead we hard-code the absolute path to
                            // the webpack output.
                            JSON.stringify(compiler.options.output.path));
                        };
                    }
                    return tapInfo;
                },
            });
        });
    }
}
exports.default = AssetRelocatorPatch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXNzZXRSZWxvY2F0b3JQYXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlsL0Fzc2V0UmVsb2NhdG9yUGF0Y2gudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxNQUFxQixtQkFBbUI7SUFLdEMsWUFBWSxNQUFlLEVBQUUsZUFBd0I7UUFDbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLENBQUM7SUFDekMsQ0FBQztJQUVPLDZCQUE2QjtRQUNuQyxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN6QiwyREFBMkQ7WUFDM0QsWUFBWTtZQUNaLE9BQU8sMENBQTBDLENBQUM7UUFDcEQsQ0FBQztRQUVELHVEQUF1RDtRQUN2RCx3REFBd0Q7UUFDeEQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRU0sS0FBSyxDQUFDLFFBQWtCO1FBQzdCLFFBQVEsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FDNUIsNkJBQTZCLEVBQzdCLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDZCwyRUFBMkU7WUFDM0Usc0NBQXNDO1lBQ3RDLEVBQUU7WUFDRixzQ0FBc0M7WUFDdEMsMElBQTBJO1lBQzFJLFdBQVcsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQztnQkFDekQsUUFBUSxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQUU7b0JBQ3BCLElBQUksT0FBTyxDQUFDLElBQUksS0FBSyx3QkFBd0IsRUFBRSxDQUFDO3dCQUM5QyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsRUFHaEIsQ0FBQzt3QkFFWixPQUFPLENBQUMsRUFBRSxHQUFHLENBQUMsTUFBYyxFQUFFLEtBQVksRUFBRSxFQUFFOzRCQUM1QyxNQUFNLGtCQUFrQixHQUFHLFVBQVUsQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7NEJBRXJELGdFQUFnRTs0QkFDaEUsNkNBQTZDOzRCQUM3QyxFQUFFOzRCQUNGLGdFQUFnRTs0QkFDaEUsSUFDRSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FDMUIsdUNBQXVDLENBQ3hDLEVBQ0QsQ0FBQztnQ0FDRCxNQUFNLElBQUksS0FBSyxDQUNiLDZHQUE2RyxDQUM5RyxDQUFDOzRCQUNKLENBQUM7NEJBRUQsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7Z0NBQ2hCLE9BQU8sa0JBQWtCLENBQUMsT0FBTyxDQUMvQixXQUFXLEVBQ1gsSUFBSSxDQUFDLDZCQUE2QixFQUFFLENBQ3JDLENBQUM7NEJBQ0osQ0FBQzs0QkFFRCxPQUFPLGtCQUFrQixDQUFDLE9BQU8sQ0FDL0IsV0FBVzs0QkFDWCwyREFBMkQ7NEJBQzNELHdEQUF3RDs0QkFDeEQsMkRBQTJEOzRCQUMzRCxzQkFBc0I7NEJBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQzdDLENBQUM7d0JBQ0osQ0FBQyxDQUFDO29CQUNKLENBQUM7b0JBRUQsT0FBTyxPQUFPLENBQUM7Z0JBQ2pCLENBQUM7YUFDRixDQUFDLENBQUM7UUFDTCxDQUFDLENBQ0YsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQWhGRCxzQ0FnRkMifQ==